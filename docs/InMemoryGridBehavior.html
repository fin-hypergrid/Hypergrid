<!DOCTYPE html>

<html>
<head>
  <title>InMemoryGridBehavior.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="DefaultCellProvider.html">
                DefaultCellProvider.js
              </a>
            
              
              <a class="source" href="DefaultSelectionModel.html">
                DefaultSelectionModel.js
              </a>
            
              
              <a class="source" href="Excel.html">
                Excel.js
              </a>
            
              
              <a class="source" href="Hypergrid.html">
                Hypergrid.js
              </a>
            
              
              <a class="source" href="HypergridRenderer.html">
                HypergridRenderer.js
              </a>
            
              
              <a class="source" href="DefaultGridBehavior.html">
                DefaultGridBehavior.js
              </a>
            
              
              <a class="source" href="InMemoryGridBehavior.html">
                InMemoryGridBehavior.js
              </a>
            
              
              <a class="source" href="QGridBehavior.html">
                QGridBehavior.js
              </a>
            
              
              <a class="source" href="constants.html">
                constants.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>InMemoryGridBehavior.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/*jshint  bitwise: false */</span>
<span class="hljs-pi">'use strict'</span>;

<span class="hljs-keyword">var</span> DefaultGridBehavior = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./DefaultGridBehavior'</span>);
<span class="hljs-keyword">var</span> DefaultCellProvider = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../DefaultCellProvider'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>This is a very rough in memory data source example.  InMemoryGridBehavior is a more traditional gridmodel
where all data and its analytics, sorting, aggregation happen in the same process.
<br>much of this is loosely based on emerson’s original grid POC
<br>TODO:needs alot of work/bug-fixing/feature completion/tests/cleanup/commenting here…</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">InMemoryGridBehavior</span><span class="hljs-params">()</span> </span>{
    DefaultGridBehavior.call(<span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>milliseconds pause inbetween sweeps of random updates</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.permuteInterval = <span class="hljs-number">20</span>;
    <span class="hljs-keyword">this</span>.rows = <span class="hljs-number">5000</span>;
    <span class="hljs-keyword">this</span>.cols = <span class="hljs-number">100</span>;
    <span class="hljs-keyword">this</span>.values = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(<span class="hljs-keyword">this</span>.rows * <span class="hljs-keyword">this</span>.cols);
    <span class="hljs-keyword">this</span>.order = [];
    <span class="hljs-keyword">this</span>.sorts = [];
    <span class="hljs-keyword">this</span>.sortLookup = {};
    <span class="hljs-keyword">this</span>.sorted = {};
    <span class="hljs-keyword">this</span>.sortStates = [<span class="hljs-string">' -'</span>, <span class="hljs-string">' ^'</span>, <span class="hljs-string">' v'</span>];

    <span class="hljs-keyword">this</span>.createSort(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>);
    <span class="hljs-keyword">this</span>.createSort(<span class="hljs-number">0</span>, <span class="hljs-number">14</span>);
    <span class="hljs-keyword">this</span>.createSort(<span class="hljs-number">0</span>, <span class="hljs-number">22</span>);
    <span class="hljs-keyword">this</span>.initOrder();
    <span class="hljs-keyword">this</span>.initialize();
    <span class="hljs-keyword">this</span>.permute();
    <span class="hljs-keyword">this</span>.reorder();
}
<span class="hljs-keyword">var</span> proto = InMemoryGridBehavior.prototype = <span class="hljs-built_in">Object</span>.create(DefaultGridBehavior.prototype);

proto.constructor = InMemoryGridBehavior;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>default to left halign for rendering performance improvement
<br>and make cols 3, 23, 41 use special cell renderers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>proto.createCellProvider = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> provider = <span class="hljs-keyword">new</span> DefaultCellProvider();
    provider.getCell = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(config)</span> </span>{
        <span class="hljs-keyword">var</span> renderer = provider.cellCache.simpleCellRenderer;
        config.halign = <span class="hljs-string">'left'</span>;
        <span class="hljs-keyword">var</span> x = config.x;
        <span class="hljs-keyword">if</span> (x === <span class="hljs-number">41</span>) {
            renderer = provider.cellCache.sliderCellRenderer;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (x === <span class="hljs-number">23</span>) {
            renderer = provider.cellCache.sparkbarCellRenderer;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (x === <span class="hljs-number">3</span>) {
            renderer = provider.cellCache.sparklineCellRenderer;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (x === <span class="hljs-number">2</span>) {
            <span class="hljs-keyword">var</span> hex = <span class="hljs-built_in">Math</span>.floor(config.value * <span class="hljs-number">255</span> / <span class="hljs-number">100</span>).toString(<span class="hljs-number">16</span>);
            <span class="hljs-keyword">if</span> (hex.length &lt; <span class="hljs-number">1</span>) {
                hex = <span class="hljs-string">'0'</span> + hex;
            }
            <span class="hljs-keyword">var</span> bgColor = <span class="hljs-string">'#'</span> + <span class="hljs-string">'00'</span> + hex + <span class="hljs-string">'00'</span>;
            config.bgColor = bgColor;
        }
        renderer.config = config;
        <span class="hljs-keyword">return</span> renderer;
    };
    <span class="hljs-keyword">return</span> provider;
};

proto.setValues = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(c)</span> </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> x = c.xstart; x &lt; c.xstop; x = x + c.xinc) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> y = c.ystart; y &lt; c.ystop; y = y + c.yinc) {
            <span class="hljs-keyword">this</span>.setRandomValue(x, y, c.cutoff);
        }
    }
    self.changed();
};</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>fill in random data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>proto.initialize = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> config = {
        xstart: <span class="hljs-number">0</span>,
        xstop: <span class="hljs-keyword">this</span>.getColCount(),
        xinc: <span class="hljs-number">1</span>,
        ystart: <span class="hljs-number">0</span>,
        ystop: <span class="hljs-keyword">this</span>.getRowCount(),
        yinc: <span class="hljs-number">1</span>,
        cutoff: <span class="hljs-number">2</span>
    };
    <span class="hljs-keyword">this</span>.setValues(config);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>kick off randomizing data every 200ms,
<br>simulate data streaming in…</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>proto.permute = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">var</span> config = {
        xstart: <span class="hljs-keyword">this</span>.scrollLeft,
        xstop: <span class="hljs-keyword">this</span>.scrollLeft + <span class="hljs-keyword">this</span>.renderedWidth,
        xinc: <span class="hljs-number">1</span>,
        ystart: <span class="hljs-keyword">this</span>.scrollTop,
        ystop: <span class="hljs-keyword">this</span>.scrollTop + <span class="hljs-keyword">this</span>.renderedHeight,
        yinc: <span class="hljs-number">1</span>,
        cutoff: <span class="hljs-number">0.05</span>
    };
    <span class="hljs-keyword">this</span>.setValues(config);
    setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        self.permute();
    }, self.permuteInterval);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>helper function for randomizing data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rnd</span><span class="hljs-params">(max)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * max);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>helper data for efficient randomization of the data under the sparkline/bar charts</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> barRandomOffsets = [];
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">20</span>; i++) {
    barRandomOffsets.push([]);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> r = <span class="hljs-number">0</span>; r &lt; <span class="hljs-number">10</span>; r++) {
        barRandomOffsets[i].push(<span class="hljs-number">10</span> - rnd(<span class="hljs-number">20</span>));
    }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>set a random value into col/row, cutoff is the threshold to exit if the random value is outside</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>proto.setRandomValue = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(col, row, cutoff)</span> </span>{
    <span class="hljs-keyword">var</span> rand = <span class="hljs-built_in">Math</span>.random();
    <span class="hljs-keyword">var</span> val = <span class="hljs-keyword">this</span>.getValue(col, row);
    <span class="hljs-keyword">var</span> rndV;
    <span class="hljs-keyword">if</span> (rand &gt; cutoff) {
        <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">if</span> (col === <span class="hljs-number">13</span>) {
        val = rand &lt; <span class="hljs-number">0.1</span> ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">this</span>.setValue(col, row, val);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (col === <span class="hljs-number">23</span>) {
        <span class="hljs-keyword">if</span> (!val) {
            val = [rnd(<span class="hljs-number">100</span>), rnd(<span class="hljs-number">100</span>), rnd(<span class="hljs-number">100</span>), rnd(<span class="hljs-number">100</span>), rnd(<span class="hljs-number">100</span>), rnd(<span class="hljs-number">100</span>), rnd(<span class="hljs-number">100</span>), rnd(<span class="hljs-number">100</span>), rnd(<span class="hljs-number">100</span>), rnd(<span class="hljs-number">100</span>)];
        } <span class="hljs-keyword">else</span> {
            rndV = <span class="hljs-built_in">Math</span>.floor(<span class="hljs-number">60</span> * rand);
            <span class="hljs-keyword">if</span> (rndV &gt; <span class="hljs-number">19</span>) {
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-keyword">var</span> rndOffsets = barRandomOffsets[rndV];
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; rndOffsets.length; i++) {
                val[i] = <span class="hljs-built_in">Math</span>.min(<span class="hljs-built_in">Math</span>.max(<span class="hljs-number">0</span>, val[i] + rndOffsets[i]), <span class="hljs-number">100</span>);
            }
        }
        <span class="hljs-keyword">this</span>.setValue(col, row, val);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (col === <span class="hljs-number">3</span>) {
        <span class="hljs-keyword">if</span> (!val) {
            val = [rnd(<span class="hljs-number">100</span>), rnd(<span class="hljs-number">100</span>), rnd(<span class="hljs-number">100</span>), rnd(<span class="hljs-number">100</span>), rnd(<span class="hljs-number">100</span>), rnd(<span class="hljs-number">100</span>), rnd(<span class="hljs-number">100</span>), rnd(<span class="hljs-number">100</span>), rnd(<span class="hljs-number">100</span>), rnd(<span class="hljs-number">100</span>)];
        } <span class="hljs-keyword">else</span> {
            rndV = <span class="hljs-built_in">Math</span>.floor(<span class="hljs-number">8000</span> * rand);
            <span class="hljs-keyword">if</span> (rndV &gt; <span class="hljs-number">99</span>) {
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-keyword">if</span> (val.shift) {
                val.shift();
                val.push(rndV);
            }
        }
        <span class="hljs-keyword">this</span>.setValue(col, row, val);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (col % <span class="hljs-number">10</span> === <span class="hljs-number">0</span>) {
        val = [rand &lt; <span class="hljs-number">0.1</span> ? <span class="hljs-literal">false</span> : <span class="hljs-literal">true</span>, <span class="hljs-number">1.0</span>];
        <span class="hljs-keyword">this</span>.setValue(col, row, val);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (col === <span class="hljs-number">9</span>) {
        <span class="hljs-keyword">if</span> (val) {
            <span class="hljs-keyword">return</span>; <span class="hljs-comment">// only set this onece</span>
        }
        <span class="hljs-keyword">var</span> hex = row.toString(<span class="hljs-number">16</span>).toUpperCase();
        <span class="hljs-keyword">while</span> (hex.length &lt; <span class="hljs-number">6</span>) {
            hex = <span class="hljs-string">'0'</span> + hex;
        }
        val = <span class="hljs-string">'0x'</span> + hex;
        <span class="hljs-keyword">this</span>.setValue(col, row, val);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (col % <span class="hljs-number">6</span> === <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">if</span> (val) {
            <span class="hljs-keyword">return</span>; <span class="hljs-comment">// only set this onece</span>
        }
        <span class="hljs-keyword">var</span> profound = <span class="hljs-string">'Quidquid latine dictum sit, altum sonatur.'</span>;
        <span class="hljs-keyword">this</span>.setValue(col, row, profound);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (col % <span class="hljs-number">4</span> === <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">var</span> ipsum = <span class="hljs-string">'Lorem ipsum dolor sit amet, malis repudiare mei in. Cu munere expetendis mea, affert aliquid definiebas at nam. Te scripta delectus singulis mel, et vidit error legere eum, ea latine feugait ponderum vix. Ius ei electram patrioque, et eum propriae deseruisse necessitatibus. Epicurei adipisci ex duo. Quidam iudicabit ullamcorper ex vel, per quot ipsum ad, libris quaeque iudicabit et usu. Ut postea nominavi cum, id eius porro mundi qui. Nec ex altera dolorum definiebas, consul viderer ex est. '</span>;
        <span class="hljs-keyword">var</span> index = <span class="hljs-built_in">Math</span>.max(<span class="hljs-number">0</span>, (rand * ipsum.length) - <span class="hljs-number">20</span>);
        val = ipsum.slice(index, index + <span class="hljs-number">20</span>).toUpperCase();
        <span class="hljs-keyword">this</span>.setValue(col, row, val);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (col === <span class="hljs-number">2</span> || col === <span class="hljs-number">14</span> || col === <span class="hljs-number">22</span>) {
        <span class="hljs-keyword">var</span> v = <span class="hljs-built_in">Math</span>.min(<span class="hljs-built_in">Math</span>.floor(rand * <span class="hljs-number">2000</span>), <span class="hljs-number">100</span>);
        <span class="hljs-keyword">this</span>.setValue(col, row, <span class="hljs-built_in">Math</span>.max(v));
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (col === <span class="hljs-number">41</span>) {
        <span class="hljs-keyword">this</span>.setValue(col, row, <span class="hljs-built_in">Math</span>.random());
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span>.setValue(col, row, rand);
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>int vector indirection layer so sorting doesn’t actually move items around</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>proto.indexOf = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(row, col)</span> </span>{
    <span class="hljs-keyword">var</span> index = (col * <span class="hljs-keyword">this</span>.rows) + row;
    <span class="hljs-keyword">return</span> index;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>create a sort object per column we consider sortable
TODO:rethink sorting encapsulation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>proto.createSort = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(type, col)</span> </span>{

    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">var</span> that = {};
    that.type = type;
    that.col = col;
    that.value = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(array, index)</span> </span>{
        <span class="hljs-keyword">return</span> array[self.indexOf(self.order[index], col)];
    };

    that.compare = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(array, first, last)</span> </span>{

        <span class="hljs-keyword">var</span> x = that.value(array, first),
            y = that.value(array, last);
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(x) === <span class="hljs-string">'number'</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Numbers are compared by subtraction</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (that.type === <span class="hljs-number">1</span>) {
                <span class="hljs-keyword">if</span> (!y) {
                    <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
                }
                <span class="hljs-keyword">return</span> x - y;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">if</span> (!y) {
                    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
                }
                <span class="hljs-keyword">return</span> y - x;
            }
        } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Anything not a number gets compared using the relational operators</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (that.type === <span class="hljs-number">1</span>) {
                <span class="hljs-keyword">if</span> (!y) {
                    <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
                }
                <span class="hljs-keyword">return</span> x &lt; y ? -<span class="hljs-number">1</span> : <span class="hljs-number">1</span>;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">if</span> (!y) {
                    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
                }
                <span class="hljs-keyword">return</span> y &lt; x ? -<span class="hljs-number">1</span> : <span class="hljs-number">1</span>;
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    };
    <span class="hljs-keyword">this</span>.sorts.push(that);
    <span class="hljs-keyword">this</span>.sortLookup[col] = that;
};

proto.swap = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(array, x, y)</span> </span>{
    <span class="hljs-keyword">var</span> tmp = <span class="hljs-keyword">this</span>.order[x];
    <span class="hljs-keyword">this</span>.order[x] = <span class="hljs-keyword">this</span>.order[y];
    <span class="hljs-keyword">this</span>.order[y] = tmp;
};

proto.compare = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(array, first, last)</span> </span>{
    <span class="hljs-keyword">var</span> comp = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>.sorts.length; ++i) {
        <span class="hljs-keyword">var</span> sort = <span class="hljs-keyword">this</span>.sorts[i];
        <span class="hljs-keyword">if</span> (sort.type !== <span class="hljs-number">0</span>) {
            comp = sort.compare(array, first, last);
            <span class="hljs-keyword">if</span> (comp === <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">continue</span>;
            }
            <span class="hljs-keyword">break</span>;
        }
    }
    <span class="hljs-keyword">return</span> comp;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>initialize int vector indirection to ascending integers 0 through row count</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>proto.initOrder = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.order = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Re-initialise the row order, as this is what we sort, not the actual data.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>.rows; ++i) {
        <span class="hljs-keyword">this</span>.order[i] = i;
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>emersons stable quicksort algorithm, hacked up by me
<br>TODO: this needs serious attention, could be exposed as part of a bowerized sorting lib</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>proto.quicksort = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(array, first, last, depth)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>In place quickstort, stable.  We cant use the inbuilt Array.sort() since its a hybrid sort
potentially and may not be stable (non quicksort) on small sizes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (depth &gt; <span class="hljs-number">1000</span>) {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'sort aborted!'</span>);
        <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">var</span> pivot = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (depth === <span class="hljs-number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Is there something to sort ??</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.sorts.length &lt;= <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span>;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Optimise for null trailing nulls.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> sort = <span class="hljs-keyword">this</span>.sorts[<span class="hljs-number">0</span>];
        <span class="hljs-keyword">while</span> (!sort.value(array, last) &amp;&amp; last &gt; first) {
            --last;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Test for worst case already sorted list…</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> sorted = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">for</span> (pivot = first; pivot &lt; last; ++pivot) {
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.compare(array, pivot, pivot + <span class="hljs-number">1</span>) &gt; <span class="hljs-number">0</span>) {
                sorted = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">break</span>;
            }
        }
        <span class="hljs-keyword">if</span> (sorted) {
            <span class="hljs-keyword">return</span>;
        }
    }
    <span class="hljs-keyword">while</span> (first &lt; last) {
        <span class="hljs-keyword">var</span> right = last;
        <span class="hljs-keyword">var</span> left = first;
        pivot = (first + last) &gt;&gt; <span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> (pivot &lt; <span class="hljs-number">0</span> || pivot &gt;= last) {
            <span class="hljs-keyword">break</span>;
        }
        <span class="hljs-keyword">while</span> (right &gt;= left) {
            <span class="hljs-keyword">while</span> (left &lt;= right &amp;&amp; <span class="hljs-keyword">this</span>.compare(array, left, pivot) &lt;= <span class="hljs-number">0</span>) {
                ++left;
            }
            <span class="hljs-keyword">while</span> (left &lt;= right &amp;&amp; <span class="hljs-keyword">this</span>.compare(array, right, pivot) &gt; <span class="hljs-number">0</span>) {
                --right;
            }
            <span class="hljs-keyword">if</span> (left &gt; right) {
                <span class="hljs-keyword">break</span>;
            }
            <span class="hljs-keyword">this</span>.swap(array, left, right);
            <span class="hljs-keyword">if</span> (pivot === right) {
                pivot = left;
            }
            left++;
            right--;
        }
        <span class="hljs-keyword">this</span>.swap(array, pivot, right);
        right--;</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Use recursion to sort the smallest partition, this increases performance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Math</span>.abs(right - first) &gt; <span class="hljs-built_in">Math</span>.abs(last - left)) {
            <span class="hljs-keyword">if</span> (left &lt; last) {
                <span class="hljs-keyword">this</span>.quicksort(array, left, last, depth + <span class="hljs-number">1</span>);
            }
            last = right;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> (first &lt; right) {
                <span class="hljs-keyword">this</span>.quicksort(array, first, right, depth + <span class="hljs-number">1</span>);
            }
            first = left;
        }
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>invoke the sorting</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>proto.reorder = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.initOrder();
    <span class="hljs-keyword">this</span>.quicksort(<span class="hljs-keyword">this</span>.values, <span class="hljs-number">0</span>, <span class="hljs-keyword">this</span>.rows - <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>give me the indirect sorted index of the data I’m looking for</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>proto.orderOf = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(y)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Provide indirection of indexing for row/col so that we can use sort and or alternate between
coloumn and row oriented sotrage.  For example to maximise performance we currently paint by
column then row, so it makes sense that the data is stored as column contiguous, but that could
be changed if filters or some other feature required it.  Also at the moment sorting is faster
if we can just copy a contigious section of the values array, and we sort on columns.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> row = <span class="hljs-keyword">this</span>.order[y];
    <span class="hljs-keyword">return</span> row;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>set value through the sorted indirection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>proto.setValue = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(col, y, value)</span> </span>{
    <span class="hljs-keyword">var</span> row = <span class="hljs-keyword">this</span>.orderOf(y);
    <span class="hljs-keyword">var</span> index = <span class="hljs-keyword">this</span>.indexOf(row, col);
    <span class="hljs-keyword">this</span>.values[index] = value;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>get value through the sorted indirection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>proto.getValue = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(col, y)</span> </span>{
    <span class="hljs-keyword">var</span> row = <span class="hljs-keyword">this</span>.orderOf(y);
    <span class="hljs-keyword">var</span> index = <span class="hljs-keyword">this</span>.indexOf(row, col);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.values[index];
};

proto.getFixedColValue = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x, y)</span> </span>{
    <span class="hljs-keyword">return</span> y;
};

proto.getRowCount = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.rows;
};

proto.getColCount = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.cols;
};

proto.getFixedRowValue = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x <span class="hljs-comment">/*, y*/</span> )</span> </span>{
    <span class="hljs-keyword">var</span> sortIndicator = <span class="hljs-string">''</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.sortLookup[x] &amp;&amp; !<span class="hljs-keyword">this</span>.sorted[x]) {
        <span class="hljs-keyword">this</span>.sorted[x] = <span class="hljs-number">0</span>;
        sortIndicator = <span class="hljs-keyword">this</span>.sortStates[<span class="hljs-keyword">this</span>.sorted[x]];
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.sorted[x]) {
        sortIndicator = <span class="hljs-keyword">this</span>.sortStates[<span class="hljs-keyword">this</span>.sorted[x]];
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.alphaFor(x) + sortIndicator;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>cols 2, 14, 22 are sortable</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>proto.fixedRowClicked = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(grid, mouse)</span> </span>{
    <span class="hljs-keyword">var</span> colIndex = <span class="hljs-keyword">this</span>.scrollLeft + mouse.cell.x - <span class="hljs-keyword">this</span>.getFixedColCount();
    <span class="hljs-keyword">if</span> ([<span class="hljs-number">2</span>, <span class="hljs-number">14</span>, <span class="hljs-number">22</span>].indexOf(colIndex) === -<span class="hljs-number">1</span>) {
        <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">this</span>.toggleSort(colIndex);
};

proto.toggleSort = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(colIndex)</span> </span>{
    <span class="hljs-keyword">var</span> current = <span class="hljs-keyword">this</span>.sorted[colIndex];
    <span class="hljs-keyword">var</span> stateCount = <span class="hljs-keyword">this</span>.sortStates.length;
    <span class="hljs-keyword">var</span> sortStateIndex = (current + <span class="hljs-number">1</span>) % stateCount;
    <span class="hljs-keyword">this</span>.sorted[colIndex] = sortStateIndex;
    <span class="hljs-keyword">this</span>.sortLookup[colIndex].type = sortStateIndex;
    <span class="hljs-keyword">this</span>.reorder();
    <span class="hljs-keyword">this</span>.changed();
};

<span class="hljs-built_in">module</span>.exports = InMemoryGridBehavior;
<span class="hljs-keyword">if</span> (<span class="hljs-built_in">window</span>) { <span class="hljs-comment">//jshint ignore:line</span>
    <span class="hljs-built_in">window</span>.InMemoryGridBehavior = InMemoryGridBehavior; <span class="hljs-comment">//jshint ignore:line</span>
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
